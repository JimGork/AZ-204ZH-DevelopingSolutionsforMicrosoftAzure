---
lab:
    title: '实验室：使用逻辑应用自动执行业务流程'
    az204Module: '模块 9：开发应用服务逻辑应用'
---
    
# 实验室: 使用逻辑应用自动执行业务流程
# 学生实验室手册

## 实验室场景

你的组织在 Microsoft Azure 的服务器消息块 (SMB) 文件共享中保留了用于配置第三方产品的 JSON 文件集合。作为常规审核实践的一部分，运营团队希望调用简单的 HTTP 终结点并检索当前的配置文件列表。你已决定使用基于 Azure API 管理服务和逻辑应用的无代码解决方案来实现此功能。

## 目标

完成本实验室后，你将能够：

-   创建逻辑应用工作流。

-   在逻辑应用中管理产品和 API。

-   将 Azure API 管理用作逻辑应用的代理。

## 实验室设置

-   预计用时：**45 分钟**

## 说明

### 开始前

#### 登录实验室虚拟机

请确保你已使用以下凭据登录到你的 Windows 10 虚拟机：
    
-   用户名：**管理员**

-   密码：**Pa55w.rd**

#### 评价已安装的应用程序

在你的 Windows 10 桌面上找到任务栏。任务栏里有本实验室中你将使用的应用程序的图标：

-   Microsoft Edge

-   文件资源管理器

-   Windows 终端

### 练习 1 ：创建 Azure 资源

#### 任务 1：打开 Azure 门户

1.  登录到 Azure 门户 (<https://portal.azure.com>)。

1.  如果这是你第一次登录 Azure 门户，你将会看到一个提供门户导览的对话框。选择 **“开始使用”** 跳过教程。

#### 任务 2：创建 API 管理资源

1.  在 Azure 门户中，使用以下详细信息创建一个新的 API 管理帐户：

    -   新资源组：**自动化工作流**

    -   名称：**prodapim*[yourname]***

    -   位置：**美国东部**

    -   组织名称：**Contoso**

    -   定价层：**消耗量 (99.9 SLA, ％)**

    > **注意**：等待 Azure 完成 API 管理资源的创建，再继续本实验室内容。资源创建时你会收到通知。

#### 任务 3：创建逻辑应用资源

1.  在 Azure 门户中，使用以下详细信息创建新的**逻辑应用**：
    
    -   现有资源组：**自动化工作流**

    -   名称：**prodflow*[yourname]***

    -   位置：**区域 - 美国东部**

    -   日志分析：**关闭**

    > **注意**：等待 Azure 完成创建逻辑应用资源，再继续本实验室内容。资源创建时你会收到通知。

#### 任务 4：创建存储帐户

1.  填写以下信息以创建一个新的存储帐户：
    
    -   现有资源组：**自动化工作流**

    -   名称：**prodstor*[yourname]***

    -   位置：**（美国）美国东部**

    -   性能：**标准**

    -   帐户类型：**StorageV2（常规用途 v2）**

    -   复制：**本地冗余存储 (LRS)**

    -   访问层级：**热**

    > **注意**：等待 Azure 完成创建存储帐户后，再继续本实验室内容。你将在帐户创建完毕后收到通知。

#### 任务 5：将示例内容上传到 Azure 文件

1.  访问之前在本实验室中创建的 **prodstor*[yourname]*** 存储帐户。

1.  选择 **“文件服务”** 部分的 **“文件共享”** 链接，然后使用以下设置创建新的共享：
    
    - 名称：**元数据**

    - 配额：**1** (GiB) 

1.  选择最近创建的 **“元数据”** 共享。
    
1.  在**元数据**共享中，选择 **“上传”**，上传 **Allfiles (F):** 中的以下文件你的实验室 VM 上的 **“\\Allfiles\\Labs\\09\\Starter”** 文件夹。

    -   **item_00.json**
    
    -   **item_01.json**
    
    -   **item_02.json**
    
    -   **item_03.json**
    
    -   **item_04.json** 

    > **注意**：建议启用 **“如果文件已存在，请覆盖”** 选项。

#### 回顾

在本练习中，你创建了本实验室所需的所有资源。

### 练习2：使用逻辑应用实现工作流

#### 任务 1：创建工作流触发器

1.  访问之前在本实验室中创建的 **prodflow*[yourname]*** 逻辑应用。

1.  在 **“逻辑应用设计器”** 边栏选项卡中，选择 **“空白逻辑应用”** 模板。

1.  在 **“设计器”** 区域中，添加新的触发器 - **“收到 HTTP 请求（请求）时”**，详细信息如下：

    -   方法：**GET**

#### 任务 2：创建一个查询 Azure 存储文件共享的操作

1.  在 **“设计器”** 区域，添加一个新的操作 - **“列出文件（Azure 文件存储）”**，详细信息如下：

    -   连接名称：**filesConnection**

    -   存储帐户：**prodstor*[yourname]***
    
    -   文件夹：**/metadata**
    
#### 任务 3：创建一个投射列表项属性的操作

1.  在 **“设计器”** 区域，添加新的操作 - “**选择（数据操作）**”，详细信息如下：

    -   From: **value (List files)**

    -   映射模式：**文本**

    -   映射：**名称（列出文件）**

#### 任务 4：生成 HTTP 响应操作

1.  在 **“设计器”** 区域，使用以下详细信息添加新的 **“响应（请求）”** 操作：
    
    -   状态代码：**200**
    
    -   正文：**输出（选择）**

1.  **保存**工作流。

#### 回顾

在本练习中，生成了一个基本工作流，该工作流在由 HTTP GET 请求触发时开始。然后它会查询存储服务，枚举结果，最后将这些结果作为 HTTP 响应返回。

### 练习 3：使用 Azure API 管理作为逻辑应用的代理

#### 任务 1：创建新产品

1.  访问之前在本实验室中创建的 **prodapim*[yourname]*** API 管理资源。

1.  导航到新帐户的空 **“产品”** 列表。

    > **注意**：消耗帐户一开始没有任何产品。

1.  添加一个新的产品，详细信息如下:

    -   显示名称：**免费**

    -   Id: **free** 

    -   说明：**匿名使用的免费层**

    -   状态：**已发布**

    -   需要订阅：**假**

#### 任务 2：创建与逻辑应用集成的 API

1.  导航到该帐户的 **API** 空列表。

1.  创建一个 **Logic App** - 集成的 API，详细信息如下：

    -   逻辑应用：**prodflow*[yourname]***
    
    -   显示名称：**元数据查找**

    -   名称：**metadata-lookup**

    -   说明：**查找元数据 JSON 文件**

    -   产品：**免费**

#### 任务 3：测试 API 操作

1.  导航到新 API 的 **“测试”** 选项卡。

1.  在 **“测试”** 选项卡上，执行以下操作：

    1.  选择单个 **GET** 操作。

    1.  复制 **“请求 URL”** 字段的值。（稍后将在实验室中使用此值。）

    1.  针对该操作执行测试请求。

    1.  观察测试请求的 JSON 结果。

#### 任务 4：使用 httprepl 验证端到端解决方案

1.  打开 **Windows 终端**应用程序。

1.  启动 **httprepl** 工具，然后将基本统一资源标识符 (URI) 设置为之前在实验室中使用以下示例复制的 API 操作的 **请求 URL** 的值：

    ```
    httprepl <api-operation-request-url>
    ```

    > **注意**：例如，如果 **URL** 是 **https://prodapimstudent.azure-api.net/manual/paths/invoke** ，则命令将是 **httprepl https://prodapimstudent.azure-api.net/manual/paths/invoke** 。

1.  查看 httprepl 工具显示的错误消息。出现此消息的原因是该工具正在搜索用于“遍历”API 的 Swagger 定义文件。由于逻辑应用程序未生成 Swagger 定义文件，因此需要手动遍历该 API。

1.  在工具提示中，针对 API 终结点运行 **“get”** 命令：

    ```
    get
    ```

1.  观察 JSON 响应内容。

1.  退出 **httprepl** 应用程序：

    ```
    exit
    ```

1.  关闭当前正在运行的 Windows Terminal 应用程序。

1.	返回 Azure 门户的浏览器窗口。

#### 回顾

在本练习中，将 Azure API 管理用作代理触发了逻辑应用工作流。

### 练习 4：清理订阅

#### 任务 1：打开 Azure Cloud Shell 并列出资源组

1.  在Azure 门户中，选择 **“Cloud Shell”** 图标以打开一个新的 shell 实例。

1.  如果 Cloud Shell 尚未配置，请使用默认设置为 Bash 配置 shell。

#### 任务 2：删除资源组

1.  输入以下命令，然后按下 Enter 键以删除 **AutomatedWorkflow** 资源组：

    ```
    az group delete --name AutomatedWorkflow --no-wait --yes
    ```

1.  关闭“Cloud Shell”窗格。

#### 任务 3：关闭活动应用程序

-   关闭当前正在运行的 Microsoft Edge 应用程序。

#### 复习

在本练习中，通过删除本实验中使用的资源组清理订阅。
