---
lab:
    title: '实验室：使用 Azure Functions 实现任务处理操作逻辑'
    module: '模块 02：实现 Azure Functions'
---

# 实验室:使用 Azure Functions 实现任务处理逻辑 
# 学生实验室手册

## 实验室方案

你的公司已经构建了一个可以用于解析本地 JavaScript 对象表示法（JSON）文件以进行配置设置的桌面软件工具。在最近一次会议中，为了减少与应用程序一起分发的文件数量，你的团队决定通过 URL 来提供默认配置设置，不再通过本地文件。作为团队中的新开发人员，你的任务是评估 Microsoft Azure Functions 作为此问题解决方案的有效性。

## 目标

完成本实验室后，你将能够：

-   创建一款 Functions 应用。

-   使用内置触发器创建各种功能。

-   配置函数应用触发器和输入集成。

## 实验室设置

-   预计用时： **45 分钟**

## 说明

### 开始前

#### 登录实验室虚拟机

请确保你已使用以下凭据登录到你的 Windows 10 虚拟机：
    
-   用户名： **管理员**

-   密码： **Pa55w.rd**

#### 评价已安装的应用程序

在你的 Windows 10 桌面上找到任务栏。任务栏里有本实验室中你将使用的应用程序的图标：

-   Microsoft Edge

-   文件资源管理器

-   Windows 终端

### 练习 1 ：创建 Azure 资源

#### 任务 1 ：打开 Azure 门户

1.  登录到 Azure 门户 (<https://portal.azure.com>)。

1.  如果这是你第一次登录 Azure 门户，你将会看到一个提供门户导览的对话框。选择 **“开始使用”** 以跳过教程。

#### 任务 2 ：创建 Azure 存储帐户

1.  填写以下信息以创建一个新的存储帐户：
    
    -   新资源组： **无服务器**

    -   名称： **funcstor*[yourname]***

    -   位置： **（美国）美国东部**

    -   性能： **标准**

    -   帐户类型： **StorageV2（通用 v2）。**

    -   复制： **本地冗余存储 (LRS)**

    -   访问层级： **热**

    > **注意**：等待 Azure 完成创建存储帐户后再继续本实验室内容。你将在帐户创建完毕后收到通知。

#### 任务 3：创建函数应用

1.  使用以下信息创建一个新的函数应用：

    - 现有资源组： **无服务器**

    - 应用程序名称： **funclogic*[yourname]***

    - 发布： **代码**

    - 运行时堆栈： **NET Core**

    - 区域： **美国东部**

    - 存储帐户： **funcstor*[yourname]***

    - 操作系统： **Windows**

    - 计划： **消耗**

    - 启用 Application Insights： **否** 

    > **注意**：等待 Azure 完成创建函数应用后再继续本实验室。你将会在应用创建完毕后收到通知。

#### 回顾

在本练习中，你创建了本实验室所需的所有资源。

### 练习 2：创建被 HTTP 申请触发的函数

#### 任务 1：创建 HTTP 触发的函数

1.  访问你之前在本实验室中创建的 **funclogic*[yourname]*** 函数应用。

1.  使用以下设置创建一个新函数：
    
    - 开发环境： **门户内部**

    - 模板： **Webhook + API（HTTP 触发器）**

    - 名称： **Echo**

    - 授权级别： **匿名**

#### 任务 2：写入函数代码

1.  在函数编辑器中，删除 **run.csx** 函数脚本的示例：

1.  将以下 **使用** 指令添加到库中供应用程序参考：

    ```
    using Microsoft.AspNetCore.Mvc;
    using System.Net;
    ```

1.  新创建一个 **公共静态** 方法，命名为 **Run**，它可以返回类型 **IActionResult** 的变量，并且也接受类型 **HttpRequest** 和 **ILogger** 的变量作为参数，分别命名为 *req* 和 *log*：

    ```
    public static IActionResult Run(HttpRequest req, ILogger log)
    {
    }
    ```

1.  在 **运行** 方法里，记录一条固定消息：

    ```
    log.LogInformation("Received a request");
    ```

1.  最后，将 HTTP 申请的主体作为 HTTP 响应：

    ```
    return new OkObjectResult(req.Body);
    ```

1.  保存已更新的函数脚本。

#### 任务 3：在门户中测试函数运行

1.  选择 **“日志”** 以观察编译结果。结果应包含 “编译成功” 的消息。

1.  选择 **“运行”** 以测试函数。

1.  观察运行测试的结果。结果应与原始请求正文完全一致。

#### 任务 4：获取基本函数 URL

1.  访问你之前在本实验室中创建的 **funclogic*[yourname]*** 函数应用。

1.  复制 **URL** 文本框的值。你将在稍后的实验室中使用此值。

#### 任务 5：使用 httprepl 来测试函数运行

1.  打开 Windows Terminal 应用程序。

1.  开启 **httprepl** 工具，然后将基本的统一资源标识符 (URI) 设置为你先前在本实验室中复制的 **URL** 值。

    ```
    httprepl <function-app-url>
    ```

    > **注意**：例如，如果你的 URL 是 **https://funclogicstudent.azurewebsites.net**，则你的命令就是 **httprepl https://funclogicstudent.azurewebsites.net**。

1.  在工具提示下，浏览相对的 **api/echo** 目录：

    ```
    cd api
    cd echo
    ```

1.  运行 HTTP 请求正文中所发送的 **post** 命令，通过使用 **--content** 选项，将其设置为数值 **3**：

    ```
    发布 --内容 3
    ```

1.  运行 HTTP 请求正文中所发送的 **发布** 命令。通过使用 **--内容** 选项，将其设置为数值 **5**：

    ```
    发布 --内容 5
    ```

1.  在 HTTP 请求正文中运行 **发布** 命令，再通过 **--内容** 选项设置一个字符串值 **“你好”**：

    ```
    post --content "Hello"
    ```

1.  运行 HTTP 请求正文中所发送的 **post** 命令，将其设置为 JSON 值 **{"msg": 通过使用 **“--content”** 选项获得 **“Successful”**}** 结果：

    ```
    发布 --内容 "{"msg": "Successful"}"
    ```

1.  退出 **httprepl** 应用程序：

    ```
    退出
    ```

1.  关闭当前正在运行的 Windows Terminal 应用程序。

1.	返回 Azure 门户的浏览器窗口。

#### 评价

在本练习中，你成功创建了一个基本函数。该函数可回响通过 HTTP POST 申请所发送的内容。

### 练习 3：创建一个按日程触发的函数

#### 任务 1：创建由日程触发的函数

1.  访问你之前在本实验室中创建的 **funclogic*[yourname]*** 函数应用。

1.  使用以下设置创建一个新函数：
    
    - 开发环境： **门户内部**

    - 模板： **HTTP 触发**

    - 名称： **定期**

    - 日程： **0 \* \* \* \* \***

#### 任务 2：观察函数运行

1.  在函数编辑器中，保存默认函数实现。

1.  选择 **“日志”**，然后观察大约每分钟都会发生的函数运行。每次运行函数都应向日志呈现一条简单的消息。

#### 任务 3：更新函数集成配置

1.  回到 **“函数应用”** 边栏选项卡，展开你先前在本实验室创建的 **funclogic*[你的名字]*** 函数应用的节点，然后展开 **“功能”** 和 **“重复执行”** 子节点。

1.  在 **“重复执行”** 节点下，选择 **“整合”** 节点。

1.  在 **“整合”** 部分，使用以下值来更新 **“计时器(我的计时器)”** 配置，然后保存配置更改：

    -   日程：**\*/30 \* \* \* \* \***

#### 任务 4：观察函数运行

1.  回到 **“函数应用”** 边栏选项卡，展开你先前在本实验室创建的 **funclogic* [你的名字] 函数应用的节点，然后展开 **“功能”** 节点。

1.  在 **“功能”** 节点下，选择 **“定期”** 节点。 

1.  在函数编辑器中，选择 **“日志”**。

1.  观察现在大约每 30 秒发生一次的函数运行。每次运行函数都应向日志呈现一条简单的消息。

#### 回顾

在本练习中，你创建了一个按照固定日程自动运行的函数。

### 练习 4：创建与其他服务集成的函数

#### 任务 1：创建 HTTP 触发的函数

1.  访问你之前在本实验室中创建的 **funclogic*[yourname]*** 函数应用。

1.  使用以下设置创建一个新函数：
    
    - 开发环境： **门户内部**

    - 模板： **HTTP 触发**

    - 名称： **获取设定信息**

    - 授权级别： **匿名**

#### 任务 2：上传示例内容

1.  访问之前在本实验室中创建的 **funcstor*[yourname]*** 存储帐户。

1.  选择 **“Blob 服务”** 部分里的 **“容器”** 链接，然后使用以下设置创建一个新容器：
    
    - 名称： **内容**

    - 公共访问级别： **专用（无匿名访问）**

1.  选择最近创建的 **“内容”** 容器。
    
1.  在 **“内容”** 容器里，选择 **“上传”** 以上传 **“Allfiles (F):”** 里的 **“settings.json”** 文件。 VM 实验上的 **\\Allfiles\\Labs\\02\\Starter** 文件夹。

    > **注意**：我们建议你启用 **“覆盖已存在的文件”** 选项。 

#### 任务 3：配置 HTTP 触发的函数

1.  访问你之前在本实验室中创建的 **funclogic*[yourname]*** 函数应用。

1.  在 **“函数应用”** 边栏选项卡，展开你先前在本实验中创建的 **funclogic* [你的名字] 函数应用的节点，然后展开 **“函数”** 和 **“获取设定信息”** 子节点。

1.  在 **“获取设定信息”** 节点下，选择 **“整合”** 节点。

1.  在 **“整合”** 部分，创建一个类型为 **“Azure Blob 存储”** 的新 **输入**。

1.  在 **Azure Blob 存储输入** 部分里，使用以下信息配置输入，然后保存配置更改：

    -   Blob 参数名称： **json**

    -   路径： **content/settings.json**

    -   存储帐户连接： **Azure WebJobsStorage**

1.  回到 **“整合”** 部分，选择现有的 **“HTTP 触发器”**。

1.  使用以下信息来更新 **HTTP 触发器** ，然后保存你的配置更改：

    -   允许的 HTTP 方法： **选定的方法**

    -   请求参数名称： **request**

    -   选择的 HTTP 方法： **获取**

#### 任务 4：写入函数代码

1.  在 **“函数应用”** 边栏选项卡上，展开你先前在本实验室中创建的 **funclogic*[yourname]*** 函数应用的节点，然后展开 **“函数”** 节点。

1.  在 **“函数”** 节点下，选择 **“获取设定信息”** 节点。 

1.  在函数编辑器中，删除 **run.csx** 函数脚本的示例：

1.  为应用程序将引用的库添加以下 **using** 指令：

    ```
    using Microsoft.AspNetCore.Mvc;
    using System.Net;
    ```

1.  创建一个名为 **运行** 的新 **公共静态**方法，它可以退回 **IActionResult** 的变量类型，并且也能接受作为参数而被命名成 *请求* 和 *json* 的 **HttpRequest** 和 **字符串** 类型变量：

    ```
    公共静态 IActionResult 运行（HttpRequest 请求，字符串 json）
    {
    }
    ```

1.  在 **Run** 方法里，将 *json* 参数的内容作为函数的 HTTP 响应返回：

    ```
    退回 new OkObjectResult(json)；
    ```

1.  保存已更新的函数脚本。

#### 任务 5：测试函数运行

1.  打开 Windows Terminal 应用程序。

1.  启用 **“httprepl”** 工具，然后将基本 URI 设置为你先前在本实验室复制的 URL 值。

    ```
    httprepl <function-app-url>
    ```

    > **注意**：例如，如果你的 URL 是 **https://funclogicstudent.azurewebsites.net**，则你的命令就是 **httprepl https://funclogicstudent.azurewebsites.net**。

1.  在工具提示符下，浏览到相应的 **api/getsettinginfo** 终结点：

    ```
    cd api
    cd getsettinginfo
    ```

1.  在当前的终结点，运行 **获取** 命令：

    ```
    获取
    ```

1.  观察来自函数应用响应里的 JSON 内容。

1.  退出 **httprepl** 应用程序：

    ```
    退出
    ```

1.  关闭当前正在运行的 Windows Terminal 应用程序。

1.	返回 Azure 门户的浏览器窗口。

#### 评价

在本练习中，你在 Storage 里创建了能退回 JSON 文件内容的函数。

### 练习 5：清理订阅 

#### 任务 1：打开 Azure Cloud Shell 并列出资源组

1.  在门户中，选择 **“Cloud Shell”** 图标打开一个新的 shell 实例。

1.  如果 Cloud Shell 尚未配置，请使用默认设置为 Bash 配置 shell。

1.  在门户的 **Cloud Shell** 命令提示符中，输入以下命令，然后选择“输入”以列出订阅中的所有资源组：

    ```
    AZ 组列表
    ```

1.  输入以下命令，然后选择“回车键”以获取用于删除资源组的可用命令列表：

    ```
    az group delete --help
    ```

#### 任务 2：删除资源组

1.  输入以下命令，然后选择“Enter”以删除 **无服务器** 的资源组：

    ```
    AZ 组 删除 --名称 无服务器 --否-等待 --是
    ```
    
1.  关闭门户里的 Cloud Shell 窗格。

#### 任务 3：关闭活动的应用程序

1.     当前正在运行的 Microsoft Edge 应用程序。

#### 回顾

在本练习中，你通过删除本实验室中曾经使用的资源组来清理订阅。
